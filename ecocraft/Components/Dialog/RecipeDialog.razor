@using ecocraft.Models
@using ecocraft.Services
@inject ContextService ContextService
@inject UserServerDataService UserServerDataService
@inject PriceCalculatorService PriceCalculatorService
@inject LocalizationService LocalizationService

<MudDialog Style="min-height: 500px;">
    <TitleContent>
        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
            <IconEco Obj="@Recipe.Elements.First(e => e.IsProduct() && e.Index == 0).ItemOrTag" Size="64" />
            <MudText Typo="Typo.h6">@LocalizationService.GetTranslation(Recipe)</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="12">
            <MudGrid>
                <MudItem sm="6">
                    <MudStack Spacing="1">                        
                        <MudText Style="color: #888">CraftingTable</MudText>
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <IconEco Obj="@Recipe.CraftingTable" />
                            <MudText>@LocalizationService.GetTranslation(Recipe.CraftingTable)</MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>

                <MudItem sm="6">
                    <MudStack Spacing="1">
                        <MudStack Row Spacing="3">
                            <MudText Style="color: #888">Craft Time</MudText>

                            @if ((int)GetModuleAndLavishReducePercent(false) != 1)
                            {
                                <MudText Color="Color.Secondary">
                                    @(Math.Round(1 - GetModuleAndLavishReducePercent(false), 1) * 100) %
                                </MudText>
                            }
                        </MudStack>
                        <MudStack Row Spacing="1">
                            <MudText>@GetFormatedCraftTime(Recipe.CraftMinutes)</MudText>

                            @if ((int)GetModuleAndLavishReducePercent(false) != 1)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ArrowRight" Size="Size.Small" Color="Color.Secondary"/>

                                <MudText Color="Color.Secondary">

                                    @(GetFormatedCraftTime(Recipe.CraftMinutes * GetModuleAndLavishReducePercent(false)))
                                </MudText>
                            }

                            <MudSpacer/>

                            <MudText Color="Color.Primary" Class="pl-2">@GetCraftMinutePrice() $</MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>

                <MudItem sm="6">
                    <MudStack Spacing="1">
                        <MudText Style="color: #888">Skill</MudText>
                        @if (Recipe.Skill is not null)
                        {
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <IconEco Obj="@Recipe.Skill" />
                                <MudText>@LocalizationService.GetTranslation(Recipe.Skill)</MudText>
                                <MudText>@(Recipe.SkillLevel)</MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudText>None</MudText>
                        }
                    </MudStack>
                </MudItem>

                <MudItem sm="6">
                    <MudStack Spacing="1">
                        <MudStack Row Spacing="3">
                            <MudText Style="color: #888">Labor</MudText>
                            @if ((int)GetLaborReducePercent() != 1)
                            {
                                <MudText Color="Color.Secondary">
                                    @(Math.Round(1 - GetLaborReducePercent(), 1) * 100) %
                                </MudText>
                            }
                        </MudStack>
                        <MudStack Row Spacing="1">
                            <MudText>@Recipe.Labor</MudText>

                            @if ((int)GetLaborReducePercent() != 1)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ArrowRight" Size="Size.Small" Color="Color.Secondary"/>

                                <MudText Color="Color.Secondary">
                                    @(Recipe.Labor * GetLaborReducePercent())
                                </MudText>
                            }

                            <MudSpacer/>

                            <MudText Class="pl-2" Color="Color.Primary">
                                @(Math.Round(GetLaborPrice(), 3)) $
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>

            <MudTable Items="GetUserElements()" GroupBy="_userElementsDefinition" Dense="true" Hover="true">
                <GroupHeaderTemplate>
                    <MudTh colspan="2" Class="mud-background">
                        <MudText>@context.Key</MudText>
                    </MudTh>
                    <MudTh colspan="1" Class="mud-background">
                        <MudText>$ / u</MudText>
                    </MudTh>
                    <MudTh colspan="2" Class="mud-background">
                        <MudStack Row Justify="Justify.FlexEnd">
                            @if (context.Key!.ToString() == "Ingredients")
                            {
                                <MudText Typo="Typo.body2">Total Cost:</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Primary">
                                    @(Math.Round(-1 * ElementSum(context.Items.ToList(), true) + GetLaborPrice(), 2)) $
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2">Total Price:</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Primary">
                                    @(Math.Round(ElementSum(GetProductsWithoutReintegratedElements()), 2)) $
                                </MudText>
                            }
                        </MudStack>
                    </MudTh>
                    <MudTh Class="mud-background" Style="width: 40px">
                    </MudTh>
                </GroupHeaderTemplate>
                <RowTemplate>
                    <!-- quantity -->
                    <MudTd Style="width: 60px">
                        <MudStack Row Spacing="1">
                            @(Math.Abs(context.Element.Quantity))

                            @if (context.Element.IsDynamic && (int)GetModuleAndLavishReducePercent() != 1)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ArrowRight" Size="Size.Small" Color="Color.Secondary"/>
                                <MudText Color="Color.Secondary" Typo="Typo.body2">@(Math.Abs(context.Element.Quantity) * GetModuleAndLavishReducePercent())</MudText>
                            }
                        </MudStack>
                    </MudTd>
                    <MudTd>
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <IconEco Obj="@context.Element.ItemOrTag" />
                            @LocalizationService.GetTranslation(context.Element.ItemOrTag)
                        </MudStack>
                    </MudTd>
                    <!-- unit price -->
                    <MudTd>
                        <MudText Typo="Typo.body2" Color="Color.Primary">
                            @(context.Price is not null ? Math.Round((decimal)context.Price!, 2) + " $" : "")
                        </MudText>
                    </MudTd>
                    <!-- dynamic info -->
                    <MudTd>
                        @if (context.Element.IsDynamic && (int)GetModuleAndLavishReducePercent() != 1)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@(Math.Round((1 - GetModuleAndLavishReducePercent()), 3) * 100) %</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2">@(context.Element.IsDynamic ? "dynamic" : "static")</MudText>
                        }
                    </MudTd>
                    <!-- price -->
                    <MudTd>
                        <MudStack Row Justify="Justify.FlexEnd">
                            <MudText Typo="Typo.body2" Color="Color.Primary">
                                @(context.Price is not null
                                    ? Math.Round((decimal)context.Price! * (context.Element.IsIngredient() ? -1 : 1) * (context.Element.IsDynamic
                                        ? context.Element.Quantity * GetModuleAndLavishReducePercent()
                                        : context.Element.Quantity), 2) + " $"
                                    : "")
                            </MudText>
                        </MudStack>
                    </MudTd>
                    <!-- deduction -->
                    <MudTd>
                        @if (context.Element.Index > 0 && context.Element.IsProduct())
                        {
                            <MudTooltip Text="@(!context.IsReintegrated ? "Deduct this item from the cost price, to be used when you can reuse this product in the same recipe or in a previous one (Molds, Barrels, ...). This will mathematically decrease the price of other products." : "Stop deducting this item from the cost price. This will mathematically increase the price of other products.")">
                                <MudIconButton Icon="@(context.IsReintegrated ? Icons.Material.Filled.KeyboardDoubleArrowDown : Icons.Material.Filled.KeyboardDoubleArrowUp)"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               OnClick="@(() => ChangeReintegrate(context, !context.IsReintegrated))"/>
                            </MudTooltip>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>

            @if (ShouldDisplayShare())
            {
                var list = GetProductsWithoutReintegratedElements();

                <MudStack>
                    <MudText Class="mt-2" Typo="Typo.body2">Price Sharing between outputs:</MudText>
                    <MudChart ChartType="ChartType.Donut"
                              LegendPosition="Position.Right"
                              Width="150px"
                              Height="150px"
                              InputData="@(list.Select(ue => (double)ue.Share).ToArray())"
                              InputLabels="@(list.Select(ue => LocalizationService.GetTranslation(ue.Element.ItemOrTag) + " (" + Math.Round(ue.Share * 100) + "%)").ToArray())"/>
                    <MudStack>
                        @for (var i = 0; i < list.Count; i++)
                        {
                            var product = list[i];
                            int index = i;

                            <MudStack Row>
                                <MudText Style="min-width: 100px">
                                    @(LocalizationService.GetTranslation(product.Element.ItemOrTag)):
                                </MudText>
                                <MudSlider T="decimal"
                                           Style="max-width: 350px"
                                           Color="@_sliderColors[index % 3]"
                                           Immediate="false"
                                           Value="product.Share"
                                           ValueChanged="@(v => ChangeShare(product, v))"
                                           Max="1"
                                           Min="0"
                                           Disabled="_lockedSliders.Contains(product)"
                                           Step="0.01m"/>
                                <MudIconButton
                                    Size="Size.Small"
                                    OnClick="@(() => ChangeLockSliders(product))"
                                    Icon="@(_lockedSliders.Contains(product) ? Icons.Material.Filled.Lock : Icons.Material.Outlined.Lock)"/>
                            </MudStack>
                        }
                    </MudStack>
                    <MudStack Row>
                        <MudButton OnClick="FirstOnly">Only First Product</MudButton>
                        <MudButton OnClick="Honest">80% First Product</MudButton>
                        <MudButton OnClick="Equality">Fair Distribution</MudButton>
                        @if (list.Any(e => (int)e.Element.Quantity != (int)list.Max(i => i.Element.Quantity)))
                        {
                            <MudButton OnClick="Equilibrate">Distribute by Quantity</MudButton>
                        }
                    </MudStack>
                </MudStack>
            }
        </MudStack>
    </DialogContent>
</MudDialog>


@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Recipe Recipe { get; set; }

    private readonly Color[] _sliderColors = [Color.Primary, Color.Tertiary, Color.Warning];
    private readonly List<UserElement> _lockedSliders = [];

    private readonly TableGroupDefinition<UserElement> _userElementsDefinition = new()
    {
        Indentation = false,
        Expandable = false,
        IsInitiallyExpanded = true,
        Selector = e => e.Element.IsIngredient() || e.IsReintegrated ? "Ingredients" : "Products"
    };

    private bool ShouldDisplayShare()
    {
        return Recipe.Elements.Count(e => e.IsProduct() && !UserServerDataService.UserElements.First(ue => ue.Element == e).IsReintegrated) > 1;
    }

    private async Task ChangeReintegrate(UserElement userElement, bool value)
    {
        userElement.IsReintegrated = value;
        var userPrice = UserServerDataService.UserPrices.First(up =>up.ItemOrTag == userElement.Element.ItemOrTag);
        if (userPrice.PrimaryUserElement == userElement)
        {
            userPrice.PrimaryUserElement = null;
        }
        await FirstOnly();
        await PriceCalculatorService.Calculate();
        StateHasChanged();
    }

    private void ChangeLockSliders(UserElement userElement)
    {
        if (_lockedSliders.Contains(userElement))
        {
            _lockedSliders.Remove(userElement);
        }
        else
        {
            _lockedSliders.Add(userElement);
        }
    }

    private decimal ElementSum(List<UserElement> userElements, bool reverseDeduction = false, bool withReduction = true)
    {
        var ingredientCostSum = userElements.Sum(ue => ue.Price * ue.Element.Quantity
                                                                * (ue.Element.IsDynamic & withReduction! ? GetModuleAndLavishReducePercent() : 1)
                                                                * (ue.IsReintegrated && reverseDeduction ? -1 : 1));
        return ingredientCostSum ?? 0;
    }

    private List<UserElement> GetProductsWithoutReintegratedElements()
    {
        return GetUserElements().Where(e => e.Element.IsProduct() && !e.IsReintegrated).ToList();
    }

    private decimal GetLaborPrice()
    {
        return Recipe.Labor
            * UserServerDataService.UserSetting!.CalorieCost / 1000
            * GetLaborReducePercent();
    }

    private decimal GetLaborReducePercent()
    {
        return Recipe.Skill?.LaborReducePercent[UserServerDataService.UserSkills.First(us => us.Skill == Recipe.Skill).Level] ?? 1;
    }

    private decimal GetModuleAndLavishReducePercent(bool withLavish = true)
    {
        var pluginModulePercent = UserServerDataService.UserCraftingTables.First(uct => uct.CraftingTable == Recipe.CraftingTable).PluginModule?.Percent ?? 1;
        var userRecipe = UserServerDataService.UserRecipes.First(ur => ur.Recipe == Recipe);
        var userSkill = UserServerDataService.UserSkills.First(us => us.Skill == Recipe.Skill);

        var lavishTalentValue = withLavish ? userRecipe.Recipe.Skill?.LavishTalentValue ?? 1 : 1;

        return userSkill.HasLavishTalent ? pluginModulePercent * lavishTalentValue : pluginModulePercent;
    }

    private decimal GetCraftMinutePrice()
    {
        return Recipe.CraftMinutes
            * UserServerDataService.UserCraftingTables.First(u => u.CraftingTable == Recipe.CraftingTable).CraftMinuteFee;
    }

    public string GetFormatedCraftTime(decimal craftMinutes)
    {
        int totalSeconds = (int)(craftMinutes * 60);
        int minutes = totalSeconds / 60;
        int seconds = totalSeconds % 60;
        return $"{minutes} min {seconds} s";
    }

    private List<UserElement> GetUserElements()
    {
        return Recipe.Elements.OrderBy(e => e.IsProduct()).ThenBy(e => e.Index).Select(e => UserServerDataService.UserElements.First(ue => ue.Element == e))
            .ToList();
    }

    private async Task ChangeShare(UserElement userElement, decimal value)
    {
        var others = GetProductsWithoutReintegratedElements().Where(ue => ue != userElement).ToList();
        var lockedOthers = others.Where(ue => _lockedSliders.Contains(ue)).ToList();
        var unlockedOthers = others.Where(ue => !_lockedSliders.Contains(ue)).ToList();

        if (unlockedOthers.Count == 0)
        {
            return;
        }

        var result = (1 - lockedOthers.Sum(l => l.Share) - value) / unlockedOthers.Count;

        if (result < 0)
        {
            return;
        }

        userElement.Share = value;

        foreach (var other in unlockedOthers)
        {
            other.Share = (1 - lockedOthers.Sum(l => l.Share) - userElement.Share) / unlockedOthers.Count;
        }

        await PriceCalculatorService.Calculate();
        StateHasChanged();
    }

    private async Task Equality()
    {
        var userElements = GetProductsWithoutReintegratedElements();

        foreach (var userElement in userElements)
        {
            userElement.Share = 1 / userElements.Count;
        }

        await PriceCalculatorService.Calculate();
        StateHasChanged();
    }

    private async Task Equilibrate()
    {
        var userElements = GetProductsWithoutReintegratedElements();
        var totalQuantity = userElements.Sum(p => p.Element.Quantity);

        foreach (var userElement in userElements)
        {
            userElement.Share = userElement.Element.Quantity / totalQuantity;
        }

        await PriceCalculatorService.Calculate();
        StateHasChanged();
    }

    private async Task FirstOnly()
    {
        var userElements = GetProductsWithoutReintegratedElements();

        foreach (var userElement in userElements)
        {
            userElement.Share = userElement.Element.Index == 0 ? 1 : 0;
        }

        await PriceCalculatorService.Calculate();
        StateHasChanged();
    }

    private async Task Honest()
    {
        var userElements = GetProductsWithoutReintegratedElements();

        foreach (var userElement in userElements)
        {
            userElement.Share = userElement.Element.Index == 0 ? 0.8m : 0.2m / (userElements.Count - 1);
        }

        await PriceCalculatorService.Calculate();
        StateHasChanged();
    }
}
